<%- include('./partials/header.ejs') %>

<link href="/products.css" rel="stylesheet" type="text/css">
<body>
	<%- include('./partials/nav.ejs') %>

	<div class="products-container" id="products-container">
		<!-- Categories will be added here dynamically -->
		<section class="index-product" id="index-product">		
		</section>
	</div>
</body>

<script>
	// Fetch products from the server and render them on the page
	async function fetchProducts() {
		try {
			// const response = await fetch(window.location.href +'/products');
			// const products = await response.json();
			const products = <%- JSON.stringify(products).replace(/</g, '\\u003c') %>; // Embed data without HTML entities

			// console.log(products);

			const productsContainer = document.getElementById('index-product');

			
			// // Render categories dynamically
			products.forEach(product => {


				const productDiv = document.createElement('a');
				productDiv.href = "/products/" + `${product["Category.name"]}` + "/" + `${product.productid}`;

				var prodPriceSection, buttonFunct;

				if (product.minprice > 0) {
					prodPriceSection = `From ${product.minprice}â‚¬`;
					buttonFunct = `<button type="button" class="button" onclick="event.stopPropagation(); event.preventDefault(); addToSearchList(${product.productid})">
						<span class="button__text">Add for best retailer choice</span>
						<span class="button__icon"><svg xmlns="http://www.w3.org/2000/svg" width="200px" viewBox="0 0 24 24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke="currentColor" height="24" fill="none" class="svg"><line y2="19" y1="5" x2="12" x1="12"></line><line y2="12" y1="12" x2="19" x1="5"></line></svg></span>
						</button>`;
				} else {
					prodPriceSection = `-`;
					buttonFunct = `<div class="no_ret">No retailers sell this</div>`;
				}

				productDiv.innerHTML = `
					<img src="${product.imageurl}">
					<h2>${product.name}</h2>
					<div class="price">${prodPriceSection}</div>

					${buttonFunct}
				`;

				
				productDivBox = productDiv.classList.add('index-product-box');
				productsContainer.appendChild(productDiv);
			});
		} catch (error) {
			console.error('Error fetching products: ', error);
		}
	}


	function addToSearchList(productId) {
		try {

			console.log(productId);
			
			fetch('/search/add_to_search', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ productId }),
			})
			.then(response => response.json())
			.then(data => {
				if (data.error) {
					alert(data.error);
				} else {
					alert('Product added to search list');
				}
			})
			.catch(err => console.error(err));
		} catch (error) {
			console.error('Error adding products to search list: ', error);
		}
	}


	// Call the function to fetch and display products when the page loads
	fetchProducts();
</script>

<%- include('./partials/footer.ejs') %>