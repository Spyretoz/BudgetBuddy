<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<link href="/nav_bar.css" rel="stylesheet" type="text/css">

<header>
	<div class="navbar">
		<div class="logo"><a href="/">BudgetBuddy</a></div>
		<ul class="links">
			<li><a href="/">Home</a></li>
			<li><a href="/categories">Categories</a></li>
			<li><a href="/contact">Contact</a></li>
		</ul>
		<a href="/cart" class="action_btn">
			<i class="fa fa-shopping-cart" style="font-size: 20px; position: relative;"></i>
			<% if (session.cart && session.cart.totalQuantity > 0) { %>
				<span class="cart-count"><%= session.cart.totalQuantity %></span>
			<% } %>
		</a>
		<div class="toggle_btn"><i class="fa-solid fa-bars"></i></div>
	</div>

	<div class="dropdown_menu">
		<li><a href="/">Home</a></li>
		<li><a href="/categories">Categories</a></li>
		<li><a href="/contact">Contact</a></li>
		<li><a href="/cart" class="action_btn"><i class="fa fa-shopping-cart" style="font-size:16px"></i>
			<% if (session.cart && session.cart.totalQuantity > 0) { %>
				<span class="cart-count"><%= session.cart.totalQuantity %></span>
			<% } %>
		</a></li>
	</div>


	<div class="search">
		<button type="submit" class="searchButton" onclick="searchRedirect()">
			<i class="fa fa-search"></i>
		</button>

		<input type="text" class="searchTerm" id="search-input" placeholder="What are you looking for?" onkeyup="searchProducts()">

		<ul id="search-results" class="dropdown-list"></ul>
		
		<!-- <button type="submit" class="listButton" onclick="showCategories()">
			<i class="fa-solid fa-list"></i>
		</button> -->
	</div>
</header>


<script>
	const toggleBtn = document.querySelector('.toggle_btn');
	const toggleBtnIcon = document.querySelector('.toggle_btn i');
	const dropDownMenu = document.querySelector('.dropdown_menu');

	toggleBtn.onclick = function () {
		dropDownMenu.classList.toggle('open')
		const isOpen = dropDownMenu.classList.contains('open')

		toggleBtnIcon.classList = isOpen
			? 'fa-solid fa-xmark'
			: 'fa-solid fa-bars'
	}

	// Function to fetch product suggestions as the user types
	function searchProducts() {
		let query = document.getElementById("search-input").value;

		console.log(query);


		if (query.length > 0) {
			// Updated fetch URL to match the backend route
			fetch(`/search?query=${query}`)
				.then(response => response.json())
				.then(data => {
					let resultsContainer = document.getElementById("search-results");
					resultsContainer.innerHTML = ''; // Clear previous results

					if (data.length > 0) {
						resultsContainer.style.display = 'block';
						data.forEach(product => {
							let listItem = document.createElement('li');
							// listItem.textContent = product.name;
							// listItem.onclick = function() {
							// 	document.getElementById("search-input").value = product.name;
							// 	resultsContainer.style.display = 'none';
							// 	searchRedirect();
							// };
							// Create a container for the product name, image, and price
							let productInfo = document.createElement('div');
							productInfo.innerHTML = `
								<img src="${product.imageurl}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;">
								<p>${product.name}</p>
								<p>Price: $${product.lowestPrice}</p>
							`;
							
							listItem.appendChild(productInfo);
							
							listItem.onclick = function() {
								document.getElementById("search-input").value = product.name;
								resultsContainer.style.display = 'none';
								searchRedirect();
							};

							resultsContainer.appendChild(listItem);
						});
					} else {
						resultsContainer.style.display = 'none';
					}
				})
				.catch(error => {
					console.error('Error fetching data:', error);
				});
		} else {
			document.getElementById("search-results").style.display = 'none';
		}
	}

	// Function to redirect to the search results page when a suggestion is clicked
	function searchRedirect() {
		let query = document.getElementById("search-input").value;
		if (query.length > 0) {
			window.location.href = `/search/products?q=${encodeURIComponent(query)}`;
		}
	}


	// function showCategories() {
	// 	console.log("Pressed showCategories");
	// }
</script>