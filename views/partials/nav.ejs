<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<link href="/nav_bar.css" rel="stylesheet" type="text/css">

<header>
	<div class="navbar">
		<div class="logo"><a href="/">BudgetBuddy</a></div>


		<div class="inputBox_container">
			<svg class="search_icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" alt="search icon">
				<path d="M46.599 46.599a4.498 4.498 0 0 1-6.363 0l-7.941-7.941C29.028 40.749 25.167 42 21 42 9.402 42 0 32.598 0 21S9.402 0 21 0s21 9.402 21 21c0 4.167-1.251 8.028-3.342 11.295l7.941 7.941a4.498 4.498 0 0 1 0 6.363zM21 6C12.717 6 6 12.714 6 21s6.717 15 15 15c8.286 0 15-6.714 15-15S29.286 6 21 6z">
				</path>
			</svg>
			<input class="inputBox" id="search-input" type="text" placeholder="Search For Products" onkeyup="searchProducts()">
			<ul id="search-results" class="dropdown-list"></ul>
		</div>
		



		<ul class="links">
			<li><a href="/">Home</a></li>
			<li><a href="/categories">Categories</a></li>
			<li><a href="/contact">Contact</a></li>
		</ul>

		<!-- Dynamic Sign In/Sign Up or Profile Icon -->
        <% if (session.user) { %>
            <!-- User Logged In: Profile Icon -->
            <li class="dropdown">
                <button class="profile-btn">
                    <i class="fa fa-user-circle" aria-hidden="true"></i>
                </button>
                <div class="dropdown-menu">
                    <a href="/profile">My Profile</a>
                    <a href="/orders">My Orders</a>
                    <a href="/reviews">My Reviews</a>
                    <form action="/login/logout" method="POST">
                        <button type="submit" class="logout-btn">Logout</button>
                    </form>
                </div>
            </li>
        <% } else { %>
            <!-- User Not Logged In: Sign In/Sign Up Buttons -->
            <li><a href="/login" class="nav-btn">Sign In</a></li>
        <% } %>

		<a href="/cart" class="action_btn">
			<i class="fa fa-shopping-cart" style="font-size: 20px; position: relative;"></i>
			<% if (session.cart && session.cart.totalQuantity > 0) { %>
				<span class="cart-count"><%= session.cart.totalQuantity %></span>
			<% } %>
		</a>
		<div class="toggle_btn"><i class="fa-solid fa-bars"></i></div>
	</div>

	<div class="dropdown_menu">
		<li><a href="/">Home</a></li>
		<li><a href="/categories">Categories</a></li>
		<li><a href="/contact">Contact</a></li>

		<!-- Dynamic Sign In/Sign Up or Profile Icon -->
        <% if (session.user) { %>
            <!-- User Logged In: Profile Icon -->
            <li class="dropdown">
                <button class="profile-btn">
                    <i class="fa fa-user-circle" aria-hidden="true"></i>
                </button>
                <div class="dropdown-menu">
                    <a href="/profile">My Profile</a>
                    <a href="/orders">My Orders</a>
                    <a href="/reviews">My Reviews</a>
                    <form action="/login/logout" method="POST">
                        <button type="submit" class="logout-btn">Logout</button>
                    </form>
                </div>
            </li>
        <% } else { %>
            <!-- User Not Logged In: Sign In/Sign Up Buttons -->
            <li><a href="/login" class="nav-btn">Sign In</a></li>
        <% } %>


		<li><a href="/cart" class="action_btn"><i class="fa fa-shopping-cart" style="font-size:16px"></i>
			<% if (session.cart && session.cart.totalQuantity > 0) { %>
				<span class="cart-count"><%= session.cart.totalQuantity %></span>
			<% } %>
		</a></li>
	</div>
</header>


<script>
	const toggleBtn = document.querySelector('.toggle_btn');
	const toggleBtnIcon = document.querySelector('.toggle_btn i');
	const dropDownMenu = document.querySelector('.dropdown_menu');

	toggleBtn.onclick = function () {
		dropDownMenu.classList.toggle('open')
		const isOpen = dropDownMenu.classList.contains('open')

		toggleBtnIcon.classList = isOpen
			? 'fa-solid fa-xmark'
			: 'fa-solid fa-bars'
	}

	// Function to fetch product suggestions as the user types
	function searchProducts() {
		let query = document.getElementById("search-input").value;

		if (query.length > 0) {
			// Updated fetch URL to match the backend route
			fetch(`/search?query=${query}`)
				.then(response => response.json())
				.then(data => {
					let resultsContainer = document.getElementById("search-results");
					resultsContainer.innerHTML = ''; // Clear previous results

					if (data.length > 0) {
						resultsContainer.style.display = 'block';
						data.forEach(product => {
							let listItem = document.createElement('li');
							
							
							// Create a container for the product name, image, and price
							let productInfo = document.createElement('div');
							productInfo.innerHTML = `
								<img src="${product.imageurl}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;">
								<p>${product.name}</p>
								<p>Price: $${product.minprice}</p>
							`;
							
							listItem.appendChild(productInfo);
							
							listItem.onclick = function() {
								document.getElementById("search-input").value = product.name;
								resultsContainer.style.display = 'none';
								searchRedirect();
							};

							resultsContainer.appendChild(listItem);
						});
					} else {
						resultsContainer.style.display = 'none';
					}
				})
				.catch(error => {
					console.error('Error fetching data:', error);
				});
		} else {
			document.getElementById("search-results").style.display = 'none';
		}
	}

	// Function to redirect to the search results page when a suggestion is clicked
	function searchRedirect() {
		let query = document.getElementById("search-input").value;
		if (query.length > 0) {
			window.location.href = `/search/products?q=${encodeURIComponent(query)}`;
		}
	}
</script>